<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Datumsrechner mit Einstellungen</title>
  <style>
    :root {
      --background: #ffffff;
      --text-color: #111111;
      --section-bg: #f0f0f0;
      --input-bg: #ffffff;
      --input-text: #111111;
      --button-bg: #007bff;
      --button-text: #ffffff;
      --border-color: #cccccc;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0 auto;
      padding: 1rem;
      max-width: 800px;
      background: var(--background);
      color: var(--text-color);
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 1rem;
    }

    .tab {
      flex: 1;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      background: var(--section-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-bottom: none;
      transition: background 0.3s;
    }

    .tab.active {
      background: var(--button-bg);
      color: var(--button-text);
      font-weight: bold;
    }

    .section {
      display: none;
      padding: 1rem;
      background: var(--section-bg);
      border: 1px solid var(--border-color);
      border-radius: 0.5rem;
    }

    .section.active {
      display: block;
    }

    input, select, button {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
    }

    .flash {
      animation: flash-animation 0.5s ease-in-out;
    }

    @keyframes flash-animation {
      0% {
        background-color: #ffcc00;
      }
      100% {
        background-color: var(--button-bg);
      }
    }

    #offsetOutput, #differenceOutput {
      white-space: pre-wrap;
      margin-top: 1rem;
    }

    #holidayListOffset {
      white-space: pre-wrap;
      margin-top: 1rem;
      padding: 0.5rem;
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      border-radius: 0.25rem;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h1>Datumsrechner mit Einstellungen</h1>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" onclick="switchTab('tab1')">Datum +/- X Tage</div>
    <div class="tab" onclick="switchTab('tab2')">Differenz zwischen zwei Daten</div>
    <div class="tab" onclick="switchTab('settings')">Einstellungen</div>
  </div>

  <!-- Reiter 1 -->
  <div class="section active" id="tab1">
    <h2>Datum +/- X Tage</h2>
    <label>Referenzdatum:
      <input type="date" id="referenceDate1" />
    </label>
    <label>Anzahl Tage vor/zurück (-):
      <input type="number" id="daysOffset" value="0" />
    </label>
    <button onclick="flashButton(this); calculateOffset()">Berechnen</button>
    <div id="offsetOutput"></div>
    <button id="toggleHolidaysBtn" style="margin-top: 1rem; display: none;" onclick="toggleHolidayList()">Feiertage anzeigen</button>
    <div id="holidayListOffset" style="display: none;"></div>
  </div>

  <!-- Reiter 2 -->
  <div class="section" id="tab2">
    <h2>Differenz zwischen zwei Daten</h2>
    <label>Startdatum:
      <input type="date" id="referenceDate2" />
    </label>
    <label>Zieldatum:
      <input type="date" id="comparisonDate" />
    </label>
    <button onclick="flashButton(this); calculateDifference()">Berechnen</button>
    <div id="differenceOutput"></div>
  </div>

  <!-- Einstellungen -->
  <div class="section" id="settings">
    <h2>Einstellungen</h2>
    <label>
      <input type="checkbox" id="checkWeekends" checked />
      Nur Werktage zählen
    </label>
    <label>
      <input type="checkbox" id="checkHolidays" checked />
      Feiertage herausrechnen
    </label>
    <label>Bundesland für Feiertage:
      <select id="stateSelector">
        <option value="BW">Baden-Württemberg</option>
        <option value="BY">Bayern</option>
        <option value="BE">Berlin</option>
        <option value="BB">Brandenburg</option>
        <option value="HB">Bremen</option>
        <option value="HH">Hamburg</option>
        <option value="HE">Hessen</option>
        <option value="MV">Mecklenburg-Vorpommern</option>
        <option value="NI">Niedersachsen</option>
        <option value="NW">Nordrhein-Westfalen</option>
        <option value="RP">Rheinland-Pfalz</option>
        <option value="SL">Saarland</option>
        <option value="SN">Sachsen</option>
        <option value="ST">Sachsen-Anhalt</option>
        <option value="SH">Schleswig-Holstein</option>
        <option value="TH">Thüringen</option>
      </select>
    </label>
  </div>

  <script>
    function switchTab(tabId) {
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      document.querySelectorAll(".section").forEach(section => section.classList.remove("active"));
      document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add("active");
      document.getElementById(tabId).classList.add("active");
    }

    function flashButton(button) {
      button.classList.add('flash');
      setTimeout(() => button.classList.remove('flash'), 500);
    }

    async function fetchHolidaysInRange(state, startYear, endYear) {
      let holidays = [];
      for (let year = startYear; year <= endYear; year++) {
        const res = await fetch(`https://feiertage-api.de/api/?jahr=${year}&nur_land=${state}`);
        const data = await res.json();
        for (const key in data) {
          holidays.push({
            name: data[key].name,
            date: new Date(data[key].datum)
          });
        }
      }
      return holidays;
    }

    function toggleHolidayList() {
      const list = document.getElementById("holidayListOffset");
      const btn = document.getElementById("toggleHolidaysBtn");
      if (list.style.display === "none") {
        list.style.display = "block";
        btn.innerText = "Feiertage ausblenden";
      } else {
        list.style.display = "none";
        btn.innerText = "Feiertage anzeigen";
      }
    }

    async function calculateOffset() {
      const referenceDateValue = document.getElementById("referenceDate1").value;
      const daysOffset = parseInt(document.getElementById("daysOffset").value, 10);
      const checkWeekends = document.getElementById("checkWeekends").checked;
      const checkHolidays = document.getElementById("checkHolidays").checked;
      const state = document.getElementById("stateSelector").value;

      if (!referenceDateValue) {
        alert("Bitte ein Referenzdatum eingeben!");
        return;
      }

      const referenceDate = new Date(referenceDateValue);
      const adjustedDate = new Date(referenceDate);
      adjustedDate.setDate(referenceDate.getDate() + daysOffset);

      const startYear = Math.min(referenceDate.getFullYear(), adjustedDate.getFullYear());
      const endYear = Math.max(referenceDate.getFullYear(), adjustedDate.getFullYear());

      const holidays = await fetchHolidaysInRange(state, startYear, endYear);
      let resultDate = new Date(referenceDate);
      let counter = 0;
      let holidayList = [];

      while (counter < Math.abs(daysOffset)) {
        resultDate.setDate(resultDate.getDate() + Math.sign(daysOffset));
        const isWeekend = resultDate.getDay() === 0 || resultDate.getDay() === 6;
        const matchingHoliday = holidays.find(h => h.date.toDateString() === resultDate.toDateString());

        if ((!checkWeekends || !isWeekend) && !(checkHolidays && matchingHoliday)) {
          counter++;
        }

        if (matchingHoliday && !holidayList.find(h => h.date.toDateString() === matchingHoliday.date.toDateString())) {
          holidayList.push(matchingHoliday);
        }
      }

      const formattedDate = formatDateWithWeekday(resultDate);
      document.getElementById("offsetOutput").innerText = `Ergebnisdatum: ${formattedDate}`;

      if (holidayList.length > 0) {
        holidayList.sort((a, b) => a.date - b.date);
        let listText = `Feiertage im Zeitraum:\n`;
        holidayList.forEach(holiday => {
          const weekday = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"][holiday.date.getDay()];
          listText += `- ${weekday}, ${holiday.date.toLocaleDateString("de-DE")}: ${holiday.name}\n`;
        });

        document.getElementById("holidayListOffset").innerText = listText;
        document.getElementById("toggleHolidaysBtn").style.display = "inline-block";
        document.getElementById("holidayListOffset").style.display = "none";
        document.getElementById("toggleHolidaysBtn").innerText = "Feiertage anzeigen";
      } else {
        document.getElementById("toggleHolidaysBtn").style.display = "none";
        document.getElementById("holidayListOffset").style.display = "none";
      }
    }

    async function calculateDifference() {
      const startDateValue = document.getElementById("referenceDate2").value;
      const endDateValue = document.getElementById("comparisonDate").value;
      const checkWeekends = document.getElementById("checkWeekends").checked;
      const checkHolidays = document.getElementById("checkHolidays").checked;
      const state = document.getElementById("stateSelector").value;

      if (!startDateValue || !endDateValue) {
        alert("Bitte Start- und Zieldatum eingeben!");
        return;
      }

      let startDate = new Date(startDateValue);
      let endDate = new Date(endDateValue);
      const isBackward = startDate > endDate;

      if (isBackward) [startDate, endDate] = [endDate, startDate];

      let differenceInDays = 0;
      let holidayList = [];

      if (!checkWeekends && !checkHolidays) {
        const differenceInTime = endDate - startDate;
        differenceInDays = Math.ceil(differenceInTime / (1000 * 60 * 60 * 24)) + 1;
      } else {
        const startYear = startDate.getFullYear();
        const endYear = endDate.getFullYear();
        const holidays = await fetchHolidaysInRange(state, startYear, endYear);

        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
          const isWeekend = currentDate.getDay() === 0 || currentDate.getDay() === 6;
          const matchingHoliday = holidays.find(h => h.date.toDateString() === currentDate.toDateString());

          if ((!checkWeekends || !isWeekend) && !(checkHolidays && matchingHoliday)) {
            differenceInDays++;
          }

          if (matchingHoliday && !holidayList.find(h => h.date.toDateString() === matchingHoliday.date.toDateString())) {
            holidayList.push(matchingHoliday);
          }

          currentDate.setDate(currentDate.getDate() + 1);
        }
      }

      let direction = isBackward ? "Rückwärtszählung" : "Vorwärtszählung";
      let output = `Unterschied: ${differenceInDays} Tage (${direction})`;

      if (holidayList.length > 0) {
        output += `\n\nFeiertage im Zeitraum:\n`;
        holidayList.sort((a, b) => a.date - b.date);
        holidayList.forEach(holiday => {
          const weekday = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"][holiday.date.getDay()];
          output += `- ${weekday}, ${holiday.date.toLocaleDateString("de-DE")}: ${holiday.name}\n`;
        });
      }

      document.getElementById("differenceOutput").innerText = output;
    }

    function formatDateWithWeekday(date) {
      const weekdays = ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"];
      return `${weekdays[date.getDay()]}, ${date.toLocaleDateString("de-DE")}`;
    }

    window.onload = function () {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById("referenceDate1").value = today;
      document.getElementById("referenceDate2").value = today;
      document.getElementById("stateSelector").value = "RP";
    };
  </script>
</body>
</html>
